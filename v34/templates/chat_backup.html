<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Little Timmy Chat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .top-half {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }

    .bottom-half {
      flex: 1;
      display: flex;
      border-top: 1px solid #ccc;
    }

    #chatbox {
      flex: 1;
      border: 1px solid black;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin-bottom: 8px;
    }

    #user_input {
      flex: 1;
      padding: 5px;
    }

    .panel {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      border-left: 1px solid #ccc;
    }

    .panel:first-child {
      border-left: none;
    }

    .message-meta {
      font-size: 0.85em;
      color: gray;
    }

    .memory-text {
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div style="padding: 10px; background: #eee;">
    <h2>Little Timmy</h2>
    <div style="font-size: 0.8em; color: gray;">
      Session ID: <code id="session_id"></code>
    </div>
  </div>

  <div class="main-container">
    <!-- Chat top half -->
    <div class="top-half">
      <div id="chatbox"></div>
      <div style="display: flex; gap: 10px;">
        <input id="user_input" type="text" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- Memory + Retrieval bottom half -->
    <div class="bottom-half">
      <div class="panel">
        <h4>ðŸ§  Memory Inspector</h4>
        <div id="memory_panel">Loading...</div>
      </div>
      <div class="panel">
        <h4>ðŸ”Ž Retrieval Inspector</h4>
        <div id="retrieval_panel">Awaiting query...</div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();

    function addMessageToChatbox(sender, message) {
      const chatbox = document.getElementById("chatbox");
      const messageElement = document.createElement("div");
      messageElement.classList.add("message");

      const senderElement = document.createElement("b");
      senderElement.textContent = sender + ": ";
      messageElement.appendChild(senderElement);

      // Use textContent to prevent XSS by ensuring the message is treated as plain text
      const messageTextNode = document.createTextNode(message);
      messageElement.appendChild(messageTextNode);
      
      chatbox.appendChild(messageElement);
      chatbox.scrollTop = chatbox.scrollHeight; // Auto-scroll to the latest message
    }

    function sendMessage() {
      const input = document.getElementById("user_input");
      const message = input.value.trim();
      if (!message) return;
      input.value = "";

      addMessageToChatbox("You", message);

      // Emit to backend for regular chat handling
      socket.emit("user_message", { message });

      // Also fetch retrieval data for the current message to inspect context
      fetch(`/api/retrieve_inspect?q=${encodeURIComponent(message)}`)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return res.json();
        })
        .then(data => {
          const panel = document.getElementById("retrieval_panel");
          panel.innerHTML = ""; // Clear previous results

          if (!data.results || data.results.length === 0) {
            panel.textContent = "No matching memories found for this query.";
            return;
          }

          data.results.forEach(result => {
            const div = document.createElement("div");
            div.style.borderBottom = "1px solid #ddd";
            div.style.marginBottom = "8px";
            div.style.paddingBottom = "4px";

            const header = document.createElement('div');
            const roleB = document.createElement('b');
            roleB.textContent = result.role;
            header.appendChild(roleB);
            header.appendChild(document.createTextNode(` [${result.topic}]`));

            const meta1 = document.createElement('div');
            meta1.className = 'message-meta';
            meta1.textContent = new Date(result.timestamp).toLocaleString();

            const meta2 = document.createElement('div');
            meta2.className = 'message-meta';
            meta2.textContent = `Importance: ${result.importance} | Tags: ${result.tags.join(", ")}`;

            const text = document.createElement('div');
            text.style.fontSize = '0.9em';
            text.style.marginTop = '4px';
            text.textContent = result.text; // Safely set text content

            const meta3 = document.createElement('div');
            meta3.className = 'message-meta';
            meta3.textContent = `Similarity: ${result.distance.toFixed(4)} | Final Score: ${result.hybrid_score.toFixed(4)}`;

            div.appendChild(header);
            div.appendChild(meta1);
            div.appendChild(meta2);
            div.appendChild(text);
            div.appendChild(meta3);
            panel.appendChild(div);
          });
        })
        .catch(err => {
          const panel = document.getElementById("retrieval_panel");
          panel.innerHTML = "";
          panel.style.color = "#ff6b6b";
          panel.textContent = `Error fetching retrieval data: ${err.message}`;
          console.error("Retrieval inspector error:", err);
        });
    }

    socket.on("bot_message", function(data) {
      addMessageToChatbox("Bot", data.message);
      loadMemoryPanel(); // Refresh memory panel after bot responds
    });

    socket.on("display_user_message", function(data) {
      addMessageToChatbox("You", data.message);
    });

    document.getElementById("user_input").addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    async function loadMemoryPanel() {
      const res = await fetch("/api/memory");
      const data = await res.json();
      const panel = document.getElementById("memory_panel");
      panel.innerHTML = ""; // Clear previous content

      data.chunks.forEach(chunk => {
        const div = document.createElement("div");
        div.style.borderBottom = "1px solid #ddd";
        div.style.marginBottom = "8px";
        div.style.paddingBottom = "4px";

        const timestamp = chunk.timestamp ? new Date(chunk.timestamp).toLocaleString() : "No timestamp";
        
        const header = document.createElement('div');
        const roleB = document.createElement('b');
        roleB.textContent = chunk.role;
        header.appendChild(roleB);
        header.appendChild(document.createTextNode(` [${chunk.topic}]`));

        const meta1 = document.createElement('div');
        meta1.className = 'message-meta';
        meta1.textContent = timestamp;

        const meta2 = document.createElement('div');
        meta2.className = 'message-meta';
        meta2.textContent = `Importance: ${chunk.importance} | Tags: ${chunk.tags.join(", ")}`;

        div.appendChild(header);
        div.appendChild(meta1);
        div.appendChild(meta2);

        const textContainer = document.createElement('div');
        textContainer.className = 'memory-text';
        
        const isTruncated = chunk.text.length > 100;

        if (isTruncated) {
            const shortText = chunk.text.slice(0, 100);
            const moreText = chunk.text.slice(100);

            const shortSpan = document.createElement('span');
            shortSpan.textContent = shortText;

            const dotsSpan = document.createElement('span');
            dotsSpan.className = 'dots';
            dotsSpan.textContent = '...';

            const moreSpan = document.createElement('span');
            moreSpan.className = 'more';
            moreSpan.style.display = 'none';
            moreSpan.textContent = moreText;

            const moreButton = document.createElement('button');
            moreButton.textContent = '[more]';
            moreButton.style.marginLeft = '4px';
            moreButton.onclick = () => {
                dotsSpan.style.display = 'none';
                moreSpan.style.display = 'inline';
                moreButton.style.display = 'none';
            };

            textContainer.appendChild(shortSpan);
            textContainer.appendChild(dotsSpan);
            textContainer.appendChild(moreSpan);
            textContainer.appendChild(moreButton);
        } else {
            textContainer.textContent = chunk.text;
        }

        div.appendChild(textContainer);
        panel.appendChild(div);
      });

      document.getElementById("session_id").innerText = data.session_id || "unknown";
    }

    loadMemoryPanel();
  </script>
</body>
</html> 